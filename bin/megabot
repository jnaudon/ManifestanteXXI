#!/bin/bash
#
#	Bot generico web pensado principalmente para redes sociales
#		- probado en facebook
#


#funcion para copiar los datos de un formulario, input, textarea
function parse_form() {
	params=""
	#echo $1 > /dev/stderr
	for (( i=1; i <= `echo "$1" | wc -l` ; i++ )); do
		# verificar todos los valores y los copia
                name=`echo "$1" | sed -n "$i"p | tr ' ' "\n" | grep 'name' | cut -d '"' -f 2`
                value=`echo "$1" | sed -n "$i"p | tr ' ' "\n" | grep 'value' | cut -d '"' -f 2`
		if [ ! "$name" == "" ]; then
			echo " '$name' => '$value'" > /dev/stderr
			# comprueba si puede reemplazar los valores por los existentes
			eval $(echo "$VAR" | while read A B; do
				if [ "$A" == "$name" ]; then
					# reemplaza valor por los de entrada
					echo "value=$B"
					echo "cambiando '$A' => '$B'" > /dev/stderr
				fi
			done)
	                params="$params$name=$value&"
		fi
        done
	echo $params
}


# Busca el formulario principal y el accion
function parse_action() {
	# lee la pagina y pasa las cookies (reemplazar por wget)
	# nota, creo que falta eliminar los enters
	if [ "$2" == "" ]; then
		POST=""
	else
		POST="--post-data '$2'"
	fi
	echo $(	wget -U Mozilla "$1" --save-cookies $COOKIE --load-cookies $COOKIE $POST --strict-comments -qO - | tee "$TMP" \
	| sed 's/\&quot\;/"/g;' \
	| sed "s/\'/\"/g;") \
	| sed "s/<form/\n<form/g; s/<\/form>/<\/form>\n/g" \
	| grep "<form" \
	| while read FORM; do
		# busca la url del formulario
		url=`echo $FORM | sed 's/</\n</g;' | grep "<form" | tr ' ' "\n" | grep 'action' | cut -d '"' -f 2 | sed "s/^\//$baseurl\//g"`
		# busca los parametros a definir y los modifica de ser necesario
		post="$(parse_form "$(echo $FORM | sed 's/</\n</g' | grep -v "<form")")"
		if [ "$url" ]; then
			# deberia quitar las urls con search, help, etc (o un parametro para esto)
			# salidas para el proximo formulario
			echo $url $post
		        echo "$1" > /dev/stderr
		        echo "------" > /dev/stderr
		fi
	done
}

# ayuda
if [ "$1" = "" ]; then
	echo "megabot"
	echo
	echo -e "	echo 'pass 1234\n\t\temail no@mail.com\n\t\tstatus mi%20mensaje' | megabot m.facebook.com"
       	exit
fi

export COOKIE="/tmp/cookie"
export VAR=`while read line; do echo "$line"; done`
export url="http://$1"
export TMP=`mktemp`

# base de la url (por las dudas)
export baseurl=`echo $url | sed 's@.*//\([^ /]\+\)[/ ].*@\1@g'`

# borra las cookies de la anterior visita
rm $COOKIE 2> /dev/null

# mira 3 paginas buscando formularios en los que completar datos
entrada="$url"
for (( c=0; c<2; c++ )); do
	# luego este loop tiene que tener una variable
	entrada=`parse_action $entrada | grep -v search`
done

rm $COOKIE 2> /dev/null

cat $TMP
exit

	1) -buscar formulario-, no dale bola a los formularios de logout o busqueda
	2) -buscar input y textarea y value-
	3) -enviar formulario a action correspondiente-
	4) hacerlo mas simple y lindo
	5) generar trafico basura/distracci√≥n (algo ya genera)
	6) probarlo con TOR
